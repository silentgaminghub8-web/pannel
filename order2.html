<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Your Orders</title>
    <style>
        /* COMMAND 1: Disable Text Selection & Tap Highlight */
        * {
            -webkit-tap-highlight-color: transparent; /* For iOS/Android */
            -webkit-touch-callout: none; /* Disable callout, like on image long-press */
            -webkit-user-select: none;   /* Safari */
            -khtml-user-select: none;    /* Konqueror HTML */
            -moz-user-select: none;      /* Old versions of Firefox */
            -ms-user-select: none;       /* Internet Explorer/Edge */
            user-select: none;           /* Non-prefixed version, currently supported by Chrome, Opera, and Firefox */
        }
        /* Re-enable selection for form inputs to allow users to copy/paste text */
        input, textarea, select {
            -webkit-user-select: auto;
            -khtml-user-select: auto;
            -moz-user-select: auto;
            -ms-user-select: auto;
            user-select: auto;
        }

        /* General Body and Page Setup */
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #ffffff;
            color: #0F1111;
        }

        .page {
            display: none; /* Pages are hidden by default */
            padding-bottom: 100px; /* Space for the footer */
            /* padding-top is now set dynamically by JavaScript */
        }

        .page.active {
            display: block; /* The active page is shown */
        }
        
        #progress-bar-loader {
            position: fixed;
            /* 'top' is set by JS to be exactly under the header */
            left: 0;
            width: 100%;
            height: 3px;
            background-color: transparent;
            z-index: 9998;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease, visibility 0s linear 0.4s;
            overflow: hidden; /* Ensures the gradient animation is contained */
        }
        #progress-bar-loader.visible {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.1s ease, visibility 0s;
        }
        #progress-bar-loader::before {
            content: '';
            display: block;
            height: 100%;
            width: 100%;
            background-image: linear-gradient(to right, #FFA41C, #FFD814, #FFA41C);
            background-size: 200% auto;
            animation: progressBarFlow 1.2s linear infinite;
        }
        @keyframes progressBarFlow {
            0% { background-position: 0% 0; }
            100% { background-position: -100% 0; }
        }
        .content-loading {
            visibility: hidden;
            min-height: 500px; /* Prevent page jumping */
        }


        /* Header and Footer (Fixed Overlays) */
        .fixed-header, .fixed-footer {
            position: fixed;
            left: 0;
            right: 0;
            width: 100%;
            z-index: 1000;
        }

        .fixed-header {
            top: 0;
            background-color: #ffffff; /* White layer added to header */
        }

        .fixed-footer {
            bottom: 0;
            cursor: pointer; /* Indicates the footer is clickable */
        }

        .fixed-header img, .fixed-footer img {
            width: 100%;
            height: auto;
            display: block;
        }

        /* Main Page Specific Styles */
        #main-page .admin-panel-link img {
            width: 100%;
            cursor: pointer;
        }

        .module {
            padding: 16px;
        }

        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .module-header h2 {
            font-size: 1.2rem;
            font-weight: bold;
            margin: 0;
        }

        .module-header .see-more {
            font-size: 0.9rem;
            color: #007185;
            text-decoration: none;
            font-weight: normal;
            cursor: pointer; /* Change cursor to indicate it's clickable */
        }

        .buy-again-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .buy-again-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .buy-again-card img {
            max-width: 100%;
            height: 100px;
            object-fit: contain;
            margin-bottom: 8px;
        }

        .buy-again-card p {
            margin: 0;
            font-size: 0.9rem;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .separator {
            height: 8px;
            background-color: #EAEDED;
            border: none;
            margin: 0;
        }

        .purchase-history-header h2 {
            font-size: 1.2rem;
            font-weight: bold;
            margin: 0 0 4px 0;
        }

        .purchase-history-header p {
            font-size: 0.9rem;
            color: #565959;
            margin: 0;
        }

        .purchase-item-card {
            display: flex;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 12px;
            background-color: #fff;
            overflow: hidden;
            align-items: stretch;
            height: 100px;
        }

        .purchase-item-card .item-image {
            flex-basis: 90px;
            flex-shrink: 0;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: 1px solid #eee;
            background-color: #F0F2F2;
        }

        .purchase-item-card .item-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .purchase-item-card .item-info {
            flex-grow: 1;
            padding: 12px 16px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: hidden;
        }

        .purchase-item-card .item-info .item-name {
            font-weight: bold;
            margin: 0 0 4px 0;
            color: #0F1111;
            cursor: pointer;
            text-decoration: none;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

         .purchase-item-card .item-info .item-name:hover {
            color: #007185;
         }

        .purchase-item-card .item-info .item-status {
            font-size: 0.9rem;
            color: #565959;
            margin: 0;
        }

        /* Order Details Page Styles */
        .product-info-module {
            display: flex;
            padding: 16px;
            gap: 16px;
            align-items: flex-start;
        }

        .product-info-module .product-image {
            width: 150px;
            height: 150px;
            object-fit: contain;
        }

        .product-info-module .product-details {
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 150px; /* Match image height for alignment */
        }

        .product-info-module .product-details .product-name {
            color: #007185;
            font-weight: normal;
            text-decoration: none;
            font-size: 0.9rem;
            display: block;
            margin-bottom: 8px;
        }
        .product-info-module .product-details .product-name:hover {
            text-decoration: underline;
        }

        .product-info-module .product-details .share-item {
            color: #007185;
            text-decoration: none;
            font-size: 0.9rem;
            cursor: pointer;
        }
        .product-info-module .product-details .share-item:hover {
            text-decoration: underline;
        }


        .delivery-status-module {
            padding: 16px;
            border-top: 1px solid #ddd;
        }

        .delivery-status {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .delivery-status .icon {
            background-color: #007185;
            color: white;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-weight: bold;
        }

        .delivery-status .text-bold {
            font-weight: bold;
        }

        .delivery-feedback {
            margin-bottom: 16px;
        }

        .delivery-feedback .feedback-text {
            font-size: 0.8rem;
            color: #565959;
            margin-bottom: 4px;
        }

        .delivery-feedback .stars {
            color: #FFA41C;
            font-size: 1.5rem;
        }

        .list-button {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid #ddd;
            text-decoration: none;
            color: inherit;
        }

        .list-button .button-text {
            display: flex;
            flex-direction: column;
        }

        .list-button .button-text .sub-text {
            font-size: 0.8rem;
            color: #565959;
            margin-top: 2px;
        }

        .list-button .arrow {
            color: #888;
        }

        .module-with-buttons {
            padding: 0 16px;
        }
        
        .module-with-buttons .list-button:first-of-type {
            border-top: 1px solid #ddd;
        }

        .module-with-buttons h3 {
            font-size: 1.2rem;
            margin-top: 16px;
            margin-bottom: 8px;
        }

        .details-page-footer {
            padding: 16px;
            color: #565959;
            font-size: 0.9rem;
        }
        
        #image-page-content img {
            width: 100%;
            height: auto;
        }

        .details-page-ad-image {
            width: 100%;
            display: block;
            height: auto;
        }

        /* Track Page Styles */
        .track-module {
            padding: 16px;
        }
        .track-module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .track-module-header h2 {
            font-size: 1rem;
            font-weight: bold;
            margin: 0;
            flex-grow: 1;
        }
        .track-module-header .see-all-orders {
            font-size: 0.9rem;
            color: #007185;
            text-decoration: none;
            font-weight: normal;
            white-space: nowrap;
        }
        .thin-separator {
            border: none;
            border-top: 1px solid #ddd;
            margin: 0 -16px; /* Extend to full width of padding */
        }
        .full-width-image {
            width: 100%;
            height: auto;
            display: block;
        }
        .track-module .full-width-image {
            margin: 0 -16px; /* Make it bleed to the edges */
            width: calc(100% + 32px);
        }
        .thick-separator {
            border: none;
            border-top: 8px solid #EAEDED;
            margin: 0 -16px 16px -16px; /* Extend to full width and add bottom margin */
        }
        .shipping-address-section h3 {
             font-size: 1.2rem;
             margin: 0 0 8px 0;
        }
        .shipping-address-section p {
            margin: 0;
            font-size: 1rem;
            line-height: 1.4;
            white-space: pre-wrap; /* Respect newlines in address */
        }
        .order-info-section h2 {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .thick-separator-light {
             border: none;
             border-top: 1px solid #ddd;
             margin: 0;
        }
        .order-details-link {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            text-decoration: none;
            color: inherit;
            font-size: 1rem;
        }

        /* Track Page Sticky Header Styles */
        .sticky-track-header {
            position: sticky;
            /* 'top' is set by JS */
            background-color: #ffffff;
            z-index: 999;
            padding-bottom: 0 !important;
        }
        .track-product-image-container {
            padding: 16px 0;
            text-align: left;
        }
        .track-product-image {
            max-width: 80px;
            max-height: 80px;
            object-fit: contain;
        }

        /* Admin Panel Styles */
        #admin-page .admin-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 16px;
        }

        .admin-container h1, .admin-container h2 {
            text-align: center;
        }

        .form-section {
            background-color: #f7f7f7;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .form-section label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-section input[type="text"],
        .form-section input[type="url"],
        .form-section input[type="date"],
        .form-section select,
        .form-section textarea {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            font-family: inherit;
        }

        .form-section .input-wrapper {
            position: relative;
            margin-bottom: 15px;
        }
        .form-section .input-wrapper input,
        .form-section .input-wrapper select {
            margin-bottom: 0;
        }
        .clear-input {
            position: absolute;
            right: 12px;
            top: 36px;
            transform: translateY(-50%);
            cursor: pointer;
            font-size: 22px;
            color: #999;
            font-weight: bold;
            line-height: 1;
            user-select: none;
        }
        .clear-input:hover {
            color: #333;
        }
        .input-wrapper select + .clear-input {
            right: 30px;
        }


        .form-section button {
            background-color: #007185;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 1rem;
            margin-top: 10px;
        }

        .form-section button:hover {
            background-color: #005a6a;
        }
        
        .form-section button.update-mode {
            background-color: #FFA41C;
        }
        .form-section button.update-mode:hover {
             background-color: #e69519;
        }
        /* Autofill button style */
        .form-section .autofill-btn {
            background-color: #6c757d;
            margin-top: 0;
            margin-bottom: 15px;
        }
        .form-section .autofill-btn:hover {
            background-color: #5a6268;
        }


        .item-list {
            list-style: none;
            padding: 0;
        }

        .item-list li {
            background-color: #fff;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .item-list .item-name-admin {
            flex-grow: 1;
            margin-right: 10px;
        }
        
        .item-list .button-group {
            display: flex;
            gap: 5px;
        }

        .item-list li.dragging {
            opacity: 0.5;
        }
        
        .item-list button {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
            font-size: 0.8rem;
        }

        .item-list .edit-btn { background-color: #007bff; }
        .item-list .reorder-btn { background-color: #28a745; }
        .item-list .delete-btn { background-color: #dc3545; }


        .admin-list-header {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }

        .flip-btn {
            padding: 5px 10px;
            font-size: 0.8rem;
            cursor: pointer;
        }

    </style>
</head>
<body>

<div id="progress-bar-loader"></div>

<!-- Fixed Header - Visible on all pages -->
<header class="fixed-header">
    <a href="#home">
        <img src="https://ik.imagekit.io/goldencodes/Picsart_25-11-07_04-28-27-724.jpg?updatedAt=1762470033938" alt="Header Image">
    </a>
</header>

<!-- PAGE 1: Main "Your Orders" Page -->
<div id="main-page" class="page">
    <div class="content">
        <div style="padding: 16px;">
            <h1 style="font-size: 1.8rem; font-weight: bold; margin: 0;">Your Orders</h1>
        </div>

        <a href="#admin" class="admin-panel-link">
            <img src="https://ik.imagekit.io/goldencodes/Picsart_25-11-09_03-04-23-916.jpg?updatedAt=1762637690349" alt="Admin Panel">
        </a>

        <!-- "Buy again" Module -->
        <div class="module">
            <div class="module-header">
                <h2>Buy again</h2>
                <a id="open-fullscreen-btn" class="see-more">See more</a>
            </div>
            <div class="buy-again-grid" id="buy-again-container">
                <!-- Buy Again items will be injected here by JavaScript -->
            </div>
        </div>

        <!-- Separator -->
        <hr class="separator">

        <!-- "Purchase history" Module -->
        <div class="module">
            <div class="purchase-history-header">
                <h2>Purchase history</h2>
                <p>Past three months</p>
            </div>
            <div id="purchase-history-container">
                <!-- Purchase History items will be injected here by JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- PAGE 2: Order Details Page -->
<div id="details-page" class="page">
    <div class="content" id="order-details-content">
        <!-- Order details will be dynamically generated here -->
    </div>
</div>

<!-- PAGE 3: Admin Panel -->
<div id="admin-page" class="page">
    <div class="admin-container content">
        <a href="#home">&larr; Back to Main Page</a>
        <h1>Admin Panel</h1>
        
        <div class="form-section">
            <h2>Extra Settings</h2>
            <div class="input-wrapper">
                <label for="extraImageUrl">Details Page Ad Image URL:</label>
                <input type="url" id="extraImageUrl" name="extraImageUrl">
                <span class="clear-input">&times;</span>
            </div>
            <button id="saveExtraSettingsBtn">Save Extra Settings</button>
        </div>


        <p>Add, edit, reorder, or remove items. All data is saved in your browser's local storage.</p>

        <div class="form-section">
            <h2 id="form-title">Add New Item</h2>
            <form id="addItemForm">
                <input type="hidden" id="editingItemId" name="editingItemId">
                
                <div class="input-wrapper">
                    <label for="itemType">Item Type:</label>
                    <select id="itemType" name="itemType" required>
                        <option value="buyAgain">Buy Again</option>
                        <option value="purchaseHistory">Purchase History</option>
                    </select>
                    <span class="clear-input">&times;</span>
                </div>

                <div class="input-wrapper">
                    <label for="itemName">Product Name:</label>
                    <input type="text" id="itemName" name="itemName" required>
                    <span class="clear-input">&times;</span>
                </div>

                <div class="input-wrapper">
                    <label for="itemImage">Image URL:</label>
                    <input type="url" id="itemImage" name="itemImage" required>
                    <span class="clear-input">&times;</span>
                </div>
                
                <div class="input-wrapper">
                    <label for="itemImagePageUrl">Image Page URL:</label>
                    <input type="url" id="itemImagePageUrl" name="itemImagePageUrl">
                    <span class="clear-input">&times;</span>
                </div>

                <img id="imagePreview" src="" alt="Image Preview" style="max-width: 100px; height: auto; margin-top: 10px; margin-bottom: 15px; display: none; border-radius: 4px;">

                <div class="input-wrapper">
                    <label for="deliveryStatus">Delivery Status Text:</label>
                    <select id="deliveryStatus" name="deliveryStatus">
                        <option value="Delivered on">Delivered on</option>
                        <option value="Delivered Today">Delivered Today</option>
                        <option value="Arriving tomorrow">Arriving tomorrow</option>
                        <option value="Arriving on">Arriving on</option>
                        <option value="Arriving today">Arriving today</option>
                    </select>
                    <span class="clear-input">&times;</span>
                </div>

                <div class="input-wrapper">
                    <label for="orderDate">Order Date:</label>
                    <input type="date" id="orderDate" name="orderDate">
                    <span class="clear-input">&times;</span>
                </div>

                <div class="input-wrapper">
                    <label for="deliveryDate">Delivery Date (for Purchase History):</label>
                    <input type="date" id="deliveryDate" name="deliveryDate">
                    <span class="clear-input">&times;</span>
                </div>

                <div class="input-wrapper">
                    <label for="eligibleDate">Replacement Eligible Date (for Purchase History):</label>
                    <input type="date" id="eligibleDate" name="eligibleDate">
                    <span class="clear-input">&times;</span>
                </div>
                
                <div class="input-wrapper">
                    <label for="shareLink">Share Link (Optional):</label>
                    <input type="url" id="shareLink" name="shareLink">
                    <span class="clear-input">&times;</span>
                </div>

                <div class="input-wrapper">
                    <label for="shippingAddress">Shipping Address (Optional):</label>
                    <textarea id="shippingAddress" name="shippingAddress" rows="3"></textarea>
                </div>
                
                <button type="button" id="autofill-dates-btn" class="autofill-btn">Autofill Dates</button>

                <button type="submit" id="form-submit-btn">Add Item</button>
            </form>
        </div>

        <div class="current-items">
            <div class="admin-list-header">
                <h2>Current "Buy Again" Items</h2>
                <button class="flip-btn" data-type="buyAgain">Flip Order</button>
            </div>
            <ul class="item-list" id="buy-again-admin-list" data-type="buyAgain"></ul>

            <div class="admin-list-header">
                <h2>Current "Purchase History" Items</h2>
                <button class="flip-btn" data-type="purchaseHistory">Flip Order</button>
            </div>
            <ul class="item-list" id="purchase-history-admin-list" data-type="purchaseHistory"></ul>
        </div>
    </div>
</div>

<!-- PAGE 4: Full Image View Page -->
<div id="image-page" class="page">
    <div class="content" id="image-page-content">
        <!-- Full width image will be injected here -->
    </div>
</div>

<!-- PAGE 5: Track Package Page -->
<div id="track-page" class="page">
    <div class="content" id="track-page-content">
        <!-- Tracking details will be dynamically generated here by JavaScript -->
    </div>
</div>


<!-- Fixed Footer - Visible on all pages -->
<footer class="fixed-footer">
    <img src="https://ik.imagekit.io/goldencodes/Picsart_25-11-09_01-17-05-266.jpg?updatedAt=1762631248379" alt="Footer Image">
</footer>
<script>
document.addEventListener('DOMContentLoaded', () => {

    const DB = {
        get: (key) => JSON.parse(localStorage.getItem(key)) || [],
        set: (key, data) => localStorage.setItem(key, JSON.stringify(data)),
        getValue: (key) => localStorage.getItem(key) || '',
        setValue: (key, value) => localStorage.setItem(key, value),
    };

    function initializeDefaultData() {
        if (!localStorage.getItem('initialized')) {
            const defaultBuyAgain = [
                { id: 1, name: 'Writing Pad for Notes and Doodling', imageUrl: 'https://m.media-amazon.com/images/I/71d1g4ign5L._AC_UY218_.jpg', imagePageUrl: 'https://m.media-amazon.com/images/I/71d1g4ign5L.jpg', orderDate: '2025-10-15', deliveryDate: '', eligibleDate: '' },
                { id: 2, name: 'Hawkins Contura Hard Anodised Aluminium Pressure Cooker', imageUrl: 'https://m.media-amazon.com/images/I/514d-tD+i8L._AC_UY218_.jpg', imagePageUrl: 'https://m.media-amazon.com/images/I/514d-tD+i8L.jpg', orderDate: '2025-10-20', deliveryDate: '', eligibleDate: '' },
            ];
            const defaultPurchaseHistory = [
                 { id: 101, name: 'Noise Twist Go Round dial Smartwatch with 1.39" Display, Bluetooth Calling, and 7-Day Battery', imageUrl: 'https://m.media-amazon.com/images/I/61TapeOXotL._AC_UY218_.jpg', imagePageUrl: 'https://m.media-amazon.com/images/I/61TapeOXotL.jpg', orderDate: '2025-11-01', deliveryDate: '2025-11-05', eligibleDate: '2025-11-15', deliveryStatusText: 'Delivered on', shareLink: 'https://www.amazon.in/dp/B0CKL65175', shippingAddress: '1 Infinite Loop\nCupertino, CA 95014\nUnited States' },
                 { id: 102, name: 'Amazon Pay Mobile Prepaid Online Recharge Service for All Operators', imageUrl: 'https://m.media-amazon.com/images/I/51j4jB5a3rL.png', imagePageUrl: 'https://m.media-amazon.com/images/I/51j4jB5a3rL.png', orderDate: '2025-10-28', deliveryDate: '2025-10-28', eligibleDate: '2025-11-07', deliveryStatusText: 'Delivered on', shareLink: '', shippingAddress: '' },
            ];
            DB.set('buyAgainItems', defaultBuyAgain);
            DB.set('purchaseHistoryItems', defaultPurchaseHistory);
            DB.setValue('extraImageUrl', 'https://ik.imagekit.io/goldencodes/Screenshot_20251111_205647_Amazon.jpg?updatedAt=1762881134774');
            localStorage.setItem('initialized', 'true');
        }
    }

    const pages = document.querySelectorAll('.page');
    
    function showPage(pageId, params = null) {
        const loader = document.getElementById('progress-bar-loader');
        const currentlyActivePage = document.querySelector('.page.active .content');

        if (currentlyActivePage) {
            currentlyActivePage.classList.add('content-loading');
        }
        loader.classList.add('visible');

        setTimeout(() => {
            pages.forEach(page => page.classList.remove('active'));
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                if (pageId === 'details-page' && params) {
                    renderOrderDetails(params.id);
                } else if (pageId === 'image-page' && params) {
                    renderImagePage(params);
                } else if (pageId === 'track-page' && params) { // Route for Track Page
                    renderTrackPage(params.id);
                    adjustStickyHeaderTop(); // Adjust sticky header after rendering
                } else if (pageId === 'admin-page') {
                    renderAdminPanel();
                } else { // Default to main page
                    renderAllMainPageContent();
                }
                
                targetPage.classList.add('active');
                const newContent = targetPage.querySelector('.content');
                if (newContent) {
                    newContent.classList.remove('content-loading');
                }
                window.scrollTo(0, 0);
            }
            loader.classList.remove('visible');
        }, 500);
    }


    function handleRouteChange() {
        const hash = window.location.hash || '#home';
        if (hash.startsWith('#details-')) {
            const id = parseInt(hash.split('-')[1]);
            showPage('details-page', { id });
        } else if (hash.startsWith('#image-')) {
            const [, id, type] = hash.split('-');
            showPage('image-page', { id: parseInt(id), type });
        } else if (hash.startsWith('#track-')) { // Handle Track Page Route
            const id = parseInt(hash.split('-')[1]);
            showPage('track-page', { id });
        } else if (hash === '#admin') {
            showPage('admin-page');
        } else {
            showPage('main-page');
        }
    }

    function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        const userTimezoneOffset = date.getTimezoneOffset() * 60000;
        const adjustedDate = new Date(date.getTime() + userTimezoneOffset);
        return adjustedDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
    }

    function renderBuyAgainItems() {
        const items = DB.get('buyAgainItems');
        const container = document.getElementById('buy-again-container');
        container.innerHTML = '';
        items.forEach(item => {
            container.innerHTML += `
                <div class="buy-again-card">
                    <img src="${item.imageUrl}" alt="${item.name}">
                    <p>${item.name}</p> 
                </div>`;
        });
    }

    function renderPurchaseHistory() {
        const items = DB.get('purchaseHistoryItems');
        const container = document.getElementById('purchase-history-container');
        container.innerHTML = '';
        items.forEach(item => {
            const statusText = item.deliveryStatusText || 'Delivered on';
            let statusDisplay = '';

            if (['Delivered on', 'Arriving on'].includes(statusText)) {
                statusDisplay = item.deliveryDate ? `${statusText} ${formatDate(item.deliveryDate)}` : statusText.replace(' on', '');
            } else {
                statusDisplay = statusText;
            }

            container.innerHTML += `
                <div class="purchase-item-card">
                    <div class="item-image"><img src="${item.imageUrl}" alt="${item.name}"></div>
                    <div class="item-info">
                         <a href="#details-${item.id}" class="item-name">${item.name}</a>
                        <p class="item-status">${statusDisplay}</p>
                    </div>
                </div>`;
        });
    }
    
    function renderImagePage(params) {
        const { id, type } = params;
        const key = type === 'buyAgain' ? 'buyAgainItems' : 'purchaseHistoryItems';
        const items = DB.get(key);
        const item = items.find(i => i.id === id);
        const container = document.getElementById('image-page-content');
        
        if (item && item.imagePageUrl) {
            container.innerHTML = `<img src="${item.imagePageUrl}" alt="${item.name}">`;
        } else {
            container.innerHTML = '<p>Image not available.</p>';
        }
    }

    function renderOrderDetails(itemId) {
        const items = DB.get('purchaseHistoryItems');
        const item = items.find(p => p.id === itemId);
        const container = document.getElementById('order-details-content');
        if (!item) {
            container.innerHTML = '<p>Order not found.</p>';
            return;
        }
        
        const imageLinkStart = item.imagePageUrl ? `<a href="#image-${item.id}-purchaseHistory">` : '';
        const imageLinkEnd = item.imagePageUrl ? `</a>` : '';
        
        const extraImageUrl = DB.getValue('extraImageUrl');
        const extraImageHtml = extraImageUrl ? `<img src="${extraImageUrl}" alt="Advertisement" class="details-page-ad-image">` : '';
        
        const statusText = item.deliveryStatusText || 'Delivered on';
        let statusDisplay = '';
        if (['Delivered on', 'Arriving on'].includes(statusText)) {
            statusDisplay = item.deliveryDate ? `${statusText} ${formatDate(item.deliveryDate)}` : statusText.replace(' on', '');
        } else {
            statusDisplay = statusText;
        }

        container.innerHTML = `
            <div class="product-info-module">
                ${imageLinkStart}
                    <img src="${item.imageUrl}" alt="${item.name}" class="product-image">
                ${imageLinkEnd}
                <div class="product-details">
                    <span class="product-name">${item.name}</span>
                    <span class="share-item" data-product-name="${item.name}" data-share-link="${item.shareLink || ''}">Share this item</span>
                </div>
            </div>
            <div class="delivery-status-module">
                <div class="delivery-status">
                    <div class="icon">&#10003;</div>
                    <div>
                        <div class="text-bold">${statusDisplay}</div>
                        <div>Package was handed to resident</div>
                    </div>
                </div>
                <div class="delivery-feedback">
                    <div class="feedback-text">Your delivery feedback</div>
                    <div class="stars">★★★★★</div>
                </div>
                <a href="#track-${item.id}" class="list-button"><span>Track package</span><span class="arrow">&gt;</span></a>
            </div>
            <hr class="separator">
            <div class="module-with-buttons">
                <h3>Need help with your item?</h3>
                <a href="#" class="list-button"><span>Get product support</span><span class="arrow">&gt;</span></a>
                <a href="#" class="list-button">
                    <span class="button-text">
                        Replace item
                        <span class="sub-text">Eligible till ${formatDate(item.eligibleDate)}</span>
                    </span>
                    <span class="arrow">&gt;</span>
                </a>
            </div>
            
            <div class="module-with-buttons">
                <a href="#" class="list-button"><span>Buy it again</span><span class="arrow">&gt;</span></a>
            </div>

            <hr class="separator">

            <div class="module-with-buttons">
                <h3>How's your item?</h3>
                <a href="#" class="list-button"><span>Write a product review</span><span class="arrow">&gt;</span></a>
                <a href="#" class="list-button"><span>Create a video review</span><span class="arrow">&gt;</span></a>
                <a href="#" class="list-button"><span>Leave seller feedback</span><span class="arrow">&gt;</span></a>
            </div>

            <div class="module-with-buttons">
                <h3>Order info</h3>
                <a href="#" class="list-button"><span>View order details</span><span class="arrow">&gt;</span></a>
                <a href="#" class="list-button"><span>Share gift receipt</span><span class="arrow">&gt;</span></a>
                <a href="#" class="list-button"><span>Download Invoice</span><span class="arrow">&gt;</span></a>
            </div>

            <hr class="separator">
            <div class="details-page-footer">Ordered on ${formatDate(item.orderDate)}</div>
            ${extraImageHtml}
            `;
    }

    function renderTrackPage(itemId) {
        const container = document.getElementById('track-page-content');
        const items = DB.get('purchaseHistoryItems');
        const item = items.find(p => p.id === itemId);

        if (!item) {
            container.innerHTML = '<p>Item not found.</p>';
            return;
        }

        const statusText = item.deliveryStatusText || 'Delivered on';
        let statusDisplay = '';
        if (['Delivered on', 'Arriving on'].includes(statusText)) {
            statusDisplay = item.deliveryDate ? `${statusText} ${formatDate(item.deliveryDate)}` : statusText.replace(' on', '');
        } else {
            statusDisplay = statusText;
        }
        
        const defaultAddress = "Shipping address not set. Please add it in the Admin Panel.";
        const address = item.shippingAddress || defaultAddress;

        container.innerHTML = `
            <div class="track-module sticky-track-header">
                <div class="track-module-header">
                    <h2>${statusDisplay}</h2>
                    <a href="#home" class="see-all-orders">see all orders</a>
                </div>
                <div class="track-product-image-container">
                    <img src="${item.imageUrl}" alt="${item.name}" class="track-product-image">
                </div>
                <hr class="thin-separator">
            </div>

            <img src="https://ik.imagekit.io/5lz94dan6e/Picsart_25-11-14_11-02-34-382.jpg?updatedAt=1763098993861" alt="Delivery Status Map" class="full-width-image">
            
            <div class="track-module">
                <hr class="thick-separator">
                <div class="shipping-address-section">
                    <h3>Shipping Address</h3>
                    <p>${address}</p>
                </div>
                <hr class="thick-separator">
                <div class="order-info-section">
                    <h2>Order Info</h2>
                    <hr class="thick-separator-light">
                    <a href="#details-${itemId}" class="order-details-link">
                        <span>View order details</span>
                        <span class="arrow">&gt;</span>
                    </a>
                    <hr class="thick-separator-light">
                </div>
            </div>
            <img src="https://ik.imagekit.io/5lz94dan6e/Screenshot_20251114_113417_Amazon.jpg?updatedAt=1763100284624" alt="Order Details Summary" class="full-width-image">
        `;
    }

    function renderAdminList(type) {
        const key = type === 'buyAgain' ? 'buyAgainItems' : 'purchaseHistoryItems';
        const listId = type === 'buyAgain' ? 'buy-again-admin-list' : 'purchase-history-admin-list';
        const items = DB.get(key);
        const listElement = document.getElementById(listId);
        listElement.innerHTML = '';
        items.forEach(item => {
            const li = document.createElement('li');
            li.setAttribute('draggable', 'true');
            li.setAttribute('data-id', item.id);
            li.innerHTML = `
                <span class="item-name-admin">${item.name}</span>
                <div class="button-group">
                    <button class="edit-btn" data-id="${item.id}" data-type="${type}">Edit</button>
                    <button class="reorder-btn" data-id="${item.id}" data-type="${type}">Reorder</button>
                    <button class="delete-btn" data-id="${item.id}" data-type="${type}">Delete</button>
                </div>`;
            listElement.appendChild(li);
        });
    }
    
    function renderAdminPanel() {
        document.getElementById('extraImageUrl').value = DB.getValue('extraImageUrl');
        renderAdminList('buyAgain');
        renderAdminList('purchaseHistory');
    }

    function renderAllMainPageContent() {
        renderBuyAgainItems();
        renderPurchaseHistory();
    }

    const addItemForm = document.getElementById('addItemForm');
    const formTitle = document.getElementById('form-title');
    const formSubmitBtn = document.getElementById('form-submit-btn');
    const imagePreview = document.getElementById('imagePreview');
    const itemImageInput = document.getElementById('itemImage');

    function resetFormState() {
        formTitle.textContent = 'Add New Item';
        formSubmitBtn.textContent = 'Add Item';
        formSubmitBtn.classList.remove('update-mode');
        addItemForm.reset();
        document.getElementById('editingItemId').value = '';
        imagePreview.style.display = 'none';
        imagePreview.src = '';
    }

    addItemForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const editingId = parseInt(document.getElementById('editingItemId').value);
        const type = e.target.itemType.value;
        const key = type === 'buyAgain' ? 'buyAgainItems' : 'purchaseHistoryItems';
        let items = DB.get(key);

        const itemData = {
            name: e.target.itemName.value,
            imageUrl: e.target.itemImage.value,
            imagePageUrl: e.target.itemImagePageUrl.value,
            deliveryStatusText: e.target.deliveryStatus.value,
            orderDate: e.target.orderDate.value,
            deliveryDate: e.target.deliveryDate.value,
            eligibleDate: e.target.eligibleDate.value,
            shareLink: e.target.shareLink.value,
            shippingAddress: e.target.shippingAddress.value,
        };

        if (editingId) {
            const itemIndex = items.findIndex(item => item.id === editingId);
            if (itemIndex > -1) {
                items[itemIndex] = { ...items[itemIndex], ...itemData };
            }
        } else {
            const newItem = { id: Date.now(), ...itemData };
            items.push(newItem);
        }

        DB.set(key, items);
        renderAdminPanel();
        resetFormState();
    });

    document.querySelector('.admin-container').addEventListener('click', (e) => {
        const button = e.target;
        
        if (button.id === 'saveExtraSettingsBtn') {
            const extraUrl = document.getElementById('extraImageUrl').value;
            DB.setValue('extraImageUrl', extraUrl);
            alert('Extra settings saved!');
            return;
        }

        const id = parseInt(button.dataset.id);
        const type = button.dataset.type;
        if (!type) return;
        const key = type === 'buyAgain' ? 'buyAgainItems' : 'purchaseHistoryItems';
        let items = DB.get(key);

        if (button.classList.contains('delete-btn')) {
            items = items.filter(item => item.id !== id);
            DB.set(key, items);
        } else if (button.classList.contains('flip-btn')) {
            items.reverse();
            DB.set(key, items);
        } else if (button.classList.contains('reorder-btn')) {
            const itemToReorder = items.find(item => item.id === id);
            if (itemToReorder) {
                const newItem = { ...itemToReorder, id: Date.now() };
                items.push(newItem);
                DB.set(key, items);
            }
        } else if (button.classList.contains('edit-btn')) {
            const itemToEdit = items.find(item => item.id === id);
            if (itemToEdit) {
                formTitle.textContent = 'Edit Item';
                formSubmitBtn.textContent = 'Update Item';
                formSubmitBtn.classList.add('update-mode');
                
                document.getElementById('editingItemId').value = itemToEdit.id;
                document.getElementById('itemType').value = type;
                document.getElementById('itemName').value = itemToEdit.name;
                itemImageInput.value = itemToEdit.imageUrl;
                document.getElementById('itemImagePageUrl').value = itemToEdit.imagePageUrl || '';
                document.getElementById('deliveryStatus').value = itemToEdit.deliveryStatusText || 'Delivered on';
                document.getElementById('orderDate').value = itemToEdit.orderDate || '';
                document.getElementById('deliveryDate').value = itemToEdit.deliveryDate || '';
                document.getElementById('eligibleDate').value = itemToEdit.eligibleDate || '';
                document.getElementById('shareLink').value = itemToEdit.shareLink || '';
                document.getElementById('shippingAddress').value = itemToEdit.shippingAddress || '';

                if (itemImageInput.value) {
                    imagePreview.src = itemToEdit.imageUrl;
                    imagePreview.style.display = 'block';
                } else {
                    imagePreview.style.display = 'none';
                }

                formTitle.scrollIntoView({ behavior: 'smooth' });
            }
            return;
        }
        renderAdminPanel();
    });

    itemImageInput.addEventListener('input', () => {
        const url = itemImageInput.value;
        if (url) {
            imagePreview.src = url;
            imagePreview.style.display = 'block';
        } else {
            imagePreview.style.display = 'none';
        }
    });

    addItemForm.addEventListener('click', (e) => {
        if (e.target.classList.contains('clear-input')) {
            const inputField = e.target.parentElement.querySelector('input, select, textarea');
            if (inputField) {
                inputField.value = '';
                inputField.dispatchEvent(new Event('input'));
            }
        }
    });

    document.body.addEventListener('click', async (e) => {
        if (e.target.classList.contains('share-item')) {
            const productName = e.target.dataset.productName;
            const defaultShareUrl = 'https://www.amazon.in/';
            const customShareUrl = e.target.dataset.shareLink;
            const shareUrl = customShareUrl || defaultShareUrl;

            const shareText = `Check out this product: ${productName}`;

            if (navigator.share) {
                try {
                    await navigator.share({ title: 'Amazon Product', text: `${shareText}`, url: shareUrl });
                } catch (err) { console.error('Error sharing:', err); }
            } else {
                try {
                    await navigator.clipboard.writeText(`${shareText}\n${shareUrl}`);
                    alert('Link copied to clipboard!');
                } catch (err) { alert('Failed to copy link.'); }
            }
        }
    });
    
    function formatDateForInput(date) {
        const yyyy = date.getFullYear();
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const dd = String(date.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
    }

    document.getElementById('autofill-dates-btn').addEventListener('click', () => {
        const today = new Date();
        const delivery = new Date();
        delivery.setDate(today.getDate() + 2);
        const replacement = new Date();
        replacement.setDate(today.getDate() + 7);

        document.getElementById('orderDate').value = formatDateForInput(today);
        document.getElementById('deliveryDate').value = formatDateForInput(delivery);
        document.getElementById('eligibleDate').value = formatDateForInput(replacement);
    });

    const footer = document.querySelector('.fixed-footer');
    footer.addEventListener('click', () => { window.location.hash = '#home'; });

    const header = document.querySelector('.fixed-header');
    const loader = document.getElementById('progress-bar-loader');

    function adjustStickyHeaderTop() {
        const headerHeight = header.offsetHeight;
        const stickyHeader = document.querySelector('.sticky-track-header');
        if (stickyHeader) {
            stickyHeader.style.top = `${headerHeight}px`;
        }
    }
    
    function adjustLayoutForHeader() {
        const headerImg = header.querySelector('img');
        const performAdjustment = () => {
            const headerHeight = header.offsetHeight;
            loader.style.top = `${headerHeight}px`;
            pages.forEach(page => {
                page.style.paddingTop = `${headerHeight}px`;
            });
            adjustStickyHeaderTop(); // Adjust on load and resize
        };

        if (headerImg.complete) {
            performAdjustment();
        } else {
            headerImg.addEventListener('load', performAdjustment);
        }
        window.addEventListener('resize', performAdjustment);
    }

    adjustLayoutForHeader();
    initializeDefaultData();
    window.addEventListener('hashchange', handleRouteChange);
    handleRouteChange();
});
</script>

</body>
</html>
